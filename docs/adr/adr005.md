# ADR 005 – Implémentation du traitement des ordres

## Statut

Acceptée

## Contexte

Nous devons concevoir un système robuste de traitement des ordres clients qui respecte les contraintes suivantes :

- **Machine d'états claire** : Empêcher les ordres de se retrouver dans des états invalides
- **Type safety** : Utiliser le système de types de Rust pour garantir que tous les cas sont traités
- **Extensibilité** : Produire du code facilement extensible pour les futures évolutions
- **Performance** : Traiter un volume élevé d'ordres simultanément

## Décision

### Machine d'états pour les ordres

Le type `OrderStatus` définit tous les états possibles d'un ordre :

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
/// Represents the current status of an order
pub enum OrderStatus {
    /// Order has not yet been processed by the system
    Queued,
    /// The order has been received by the system
    Pending,
    /// Order has been completely executed
    Filled { date: DateTime<Utc> },
    /// Order is in the process of being cancelled
    PendingCancel,
    /// Order has been cancelled by the user
    Cancelled,
    /// Order has expired
    Expired { date: DateTime<Utc> },
    /// Order has been rejected by the system
    Rejected { date: DateTime<Utc> },
}
```

### Architecture de traitement

- **Thread pool** : La logique de traitement sera implémentée dans une thread pool pour maximiser le débit
- **Pipeline asynchrone** : Les ordres suivent un pipeline de traitement défini
- **État immutable** : Les transitions d'état sont contrôlées et traçables

## Conséquences

### Avantages

- **Type safety** : Impossible d'avoir des transitions d'état invalides
- **Performance** : Traitement parallèle des ordres via thread pool
- **Traçabilité** : Horodatage automatique des états terminaux
- **Maintenabilité** : Structure claire et extensible

### Inconvénients

- **Complexité** : Gestion de la concurrence dans la thread pool
- **Synchronisation** : Coordination nécessaire entre les threads de traitement

### Risques

- **Deadlocks** : Attention aux verrous partagés
- **Race conditions** : Gestion des accès concurrents aux données d'ordre
